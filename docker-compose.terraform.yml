version: '3'
services:

  localstack:
    image: localstack/localstack:0.11.4
    container_name: localstack
    ports:
      - "4566:4566"
    hostname: localstack
    environment:
      - EDGE_PORT=4566
      - SERVICES=dynamodb

  terraform:
    image: hashicorp/terraform:0.12.29
    depends_on:
      - localstack
    volumes:
      - ./terraform-localstack:/tmp/test/terraform
    working_dir: /opt/work
    entrypoint: sh
    command: >
      -c " cp -R /tmp/test/terraform/* /opt/work/ &&    terraform init && terraform apply -auto-approve -backup="-" -no-color &&  cp -R /opt/work/.terraform /opt/work/terraform.tfstate /tmp/test/terraform/ "
